<!DOCTYPE html>
<html>
<head>
	<title>Quizzem</title>
	<meta name="description" content="Instructor's page for creating questions and building exams.">
	<meta name="keywords"    content="Computer Science, Exam, Questions, Instructor, NJIT, Python">
	<meta name="author"      content="Devon J O'Connor">
	<meta name="viewport"    content="width=device-width, initial-scale=1.0">
</head>
<body>
	<div id="quizBuilder">
		<form id="addForm">
			<fieldset>
				<legend>Create Question:</legend>
				Description </br>
				<input id="addDesc" type="text"> </br>
				Topic </br>
				<input id="addTopic" type="text"> </br>
				<div id="addDiff">
					Difficulty </br>
					<label><input type="radio" name="diff" value="1">Very Easy</label></br>
					<label><input type="radio" name="diff" value="2">Easy	 </label></br>
					<label><input type="radio" name="diff" value="3" checked>Medium</label></br>
					<label><input type="radio" name="diff" value="4">Hard	 </label></br>
					<label><input type="radio" name="diff" value="5">Very Hard</label></br>
				</div>
				<div    id="addTests" class="modular tests"></div>
				</br>
				<button id="addSub"   type="reset">Submit</button> 
			</fieldset>
		</form>	
		<form id="searchForm">
			<fieldset>
				<legend>Search for Questions</legend>
				Topic </br>
				<input id="searchTopic" type="text"> </br>
				<div id="searchDiff">
					Difficulty </br>
					<label><input type ="checkbox" value="1">Very Easy</label></br>
					<label><input type ="checkbox" value="2">Easy	 </label></br>
					<label><input type ="checkbox" value="3">Medium   </label></br>
					<label><input type ="checkbox" value="4">Hard	 </label></br>
					<label><input type ="checkbox" value="5">Very Hard</label></br>
				</div>
				<div id   ="searchKeys" class="modular keys"></div>
				</br>
				<button id="searchSub" type="button">Submit</button> 
				<button id="searchReset" type="reset">Clear</button> 
			</fieldset>
		</form>
	</div>
	<div id="quizPreview">
		<ul id="qList"></ul>
	</div>
	<script>
	// Var to hold all locally known questions
	var localQ = [
		{ "Id":"0", "Desc":"Test","Topic":"TestTopic","Diff":"1","Tests":[ "TestTest" ] },
		{ "Id":"-1","Desc":"Rest","Topic":"TestTopic","Diff":"1","Tests":[ "TestTest" ] },
		{ "Id":"-2","Desc":"Bunt","Topic":"TestTopic","Diff":"1","Tests":[ "TestTest" ] },
		{ "Id":"-3","Desc":"Lart","Topic":"TestTopic","Diff":"1","Tests":[ "TestTest" ] },
		{ "Id":"-4","Desc":"Fits","Topic":"TestTopic","Diff":"1","Tests":[ "TestTest" ] },
	];

	/* Get all questions in database */
	sendRequest("SearchQ");

	/* Adding event listeners to submit and clear buttons 
	 * Uses the id short hand rather than document.getElementById(id) */
	addSub.addEventListener("click"   , function(){sendRequest("AddQ")});
	addSub.addEventListener("click"   , function(){clearForm("addForm")});
	searchSub.addEventListener("click", function(){sendRequest("SearchQ")});
	searchReset.addEventListener("click", function(){clearForm("searchForm")});

	/* Initializes the modular elements */
	resetModal("Test Cases", "addTests"  , 'addInput("addTests")');
	resetModal("Keywords"  , "searchKeys", 'addInput("searchKeys")');

	/* Searches through local questions returning matches
	 * Topic   : A topic to search by, "" matches all topics
	 * Diffs[] : An array of difficulties to filter by
	 * Keys[]  : An array of words to search through descriptions by */
	function localSearch(topic, diffs, keys) {
		var matches = [];
		for(var i=0; i<localQ.length; i++){
			var thisTopic = localQ[i]["Topic"].toLowerCase();
			if(topic === "" || thisTopic === topic.toLowerCase()){
				// Topic matches, now check Diffs
				var thisDiff = localQ[i]["Diff"];
				if( diffs.includes(thisDiff) ){
					// Topic and Diff matches, check Keys
					var thisDesc = localQ[i]["Desc"].toLowerCase();
					var keysChecked = 0;
					for(var j=0; j<keys.length; j++) {
						var thisKey = keys[j].toLowerCase();
						if( thisDesc.match(thisKey) ){
							// Topic, Diff, & Key matches, add to matches
							keysChecked++;
							matches.push(localQ[i]);
							break;
						}
					}
				}

			} 
		}
		return matches;
	}

	/* Add another input text box to the top of the specified element.
	 * Works for elements that contain a label, a button, and then a list of inputs 
	 * elemId: The id of the element you want to add the input box to */
	function addInput(elemId) {
		var elem      = document.getElementById(elemId);
		var textInput = document.createElement("INPUT");
		var breakElem = document.createElement("BR");
		elem.insertBefore(textInput, elem.childNodes[4]);
		elem.insertBefore(breakElem, elem.childNodes[4]);
	}
	
	/* Resets an input div to contain a label, a button for adding more inputs,
	 * and a single text input.
	 * label: The label of the input fields (e.g. Keywords, or Test Cases)
	 * elemId: The id of the button that will be added to this  
	 * func: The function that will be applied to the button */
	function resetModal(label, elemId, func) {
		var modalElem = document.getElementById(elemId);
		var brkElem   = document.createElement("BR");
		var textLabel = document.createTextNode(label);
		var btnElem   = document.createElement("BUTTON");
		var btnText   = document.createTextNode("+");
		btnElem.appendChild(btnText);
		btnElem.setAttribute("type", "button");
		btnElem.setAttribute("onclick", func);

		modalElem.innerHTML = "";
		modalElem.appendChild(textLabel);
		modalElem.appendChild(btnElem);
		modalElem.appendChild(brkElem);
		modalElem.appendChild(document.createElement("INPUT"));
		if(elemId === "addTests") {
			modalElem.appendChild(document.createElement("BR"));
			modalElem.appendChild(document.createElement("INPUT"));
		}
	}

	/* Resets all of the modular elements inside of the specified element.
	 * Modular elems are those such as keywords where more can be added
	 * The given id should contain modular elements, most likely a form */
	function clearForm(formId) {
		var elems = document.getElementById(formId).getElementsByClassName("modular");
		for(var i=0; i<elems.length; i++) {
			var classes = elems[i].classList;
			if(classes.contains("modular")) {
				if(classes.contains("tests")) {
					resetModal("Test Cases", elems[i].id, 'addInput("'+elems[i].id+'")');
				} else {
					resetModal("Keywords"  , elems[i].id, 'addInput("'+elems[i].id+'")');
				}
			}
		}
	}

	/* Returns the value of the first checked input element contained by the given element 
	 * This assumes radio input types inside a div of their own */
	function getCheckedValue(divId) {
		var elems = document.getElementById(divId).getElementsByTagName("INPUT");
		for(var i=0; i<elems.length; i++){
			if(elems[i].checked){
				return elems[i].value;
			}
		}
		return -1;
	}
	
	/* Returns an array of the checked input values inside of given element 
	 * This assumes checkbox input types inside a div of their own */
	function getCheckedValues(divId) {
		var checked = [];
		var elems = document.getElementById(divId).getElementsByTagName("INPUT");
		for(var i=0; i<elems.length; i++) {
			if(elems[i].checked) {
				checked.push(elems[i].value);
			}
		}
		if(checked.length === 0)
			checked = [1,2,3,4,5];
		return checked;
	}

	
	/* Given a number 1-5, it will return string version of that difficulty
	 * Given a string Very Easy, Easy, Medium, Hard, Very Hard return corresponding 1-5
	 * Given anything else, returns -1 */
	function convertDiffFormat(diff) {
		var swapper = {"1":"Very Easy","2":"Easy","3":"Medium","4":"Hard","5":"Very Hard",
					   "Very Easy":"1","Easy":"2","Medium":"3","Hard":"4","Very Hard":"5",};
		return swapper[diff];
	}

	/* Turns the given question into an HTML element
	 * Inserts new element into list of previewed questions */
	function addToPreview(newQ){
		var Desc     = newQ["Desc"];
		var Diff     = convertDiffFormat(newQ["Diff"]);
		var item     = document.createElement("LI");
		var br       = document.createElement("BR");
		var descText = document.createTextNode(""+Desc);
		var diffText = document.createTextNode("Difficulty: "+Diff);
		item.appendChild(descText);
		item.appendChild(br);
		item.appendChild(diffText);
		document.getElementById("qList").appendChild(item);
	}

	/* Checks the given question's Id against all Ids in localQ
	 * Returns true if given question's Id is not found */
	function uniqQuestion(question){
		var uniq = true;
		var thisId = question["Id"];
		for(var i=0; i<localQ.length; i++){
			if( localQ[i]["Id"] === thisId ) {
				uniq = false;
				break;
			}
		}
		return uniq;
	}

	function displaySearchResults() {
		var matches = localSearch(searchTopic.value, );
	}

	/* Returns all non-empty input values in an array 
	 * Takes the Id of a div element */
	function getNonEmptyInputs(divId) {
		var result = [];
		var elems = document.getElementById(divId).children;
		for(var i = 0; i < elems.length; i++) {
			if(elems[i].tagName == "INPUT")
				if(elems[i].value != "")
					result.push(elems[i].value);
		}
		return result;
	}

	/* Sends the specified type of request to the server 
	 * Types so far: AddQ, SearchQ 
	 * AddQ sends: { type, desc, diff, keys, tests }
	 *    type is always AddQ
	 *    desc is the question prompt student will see when taking test
	 *    diff is the difficulty specified by instructor for that question
	 *    keys is an array of keywords that can be used to search for this question
	 *    tests is an arry of tests that should pass if student gives correct answer
	 *        Format in which tests should be given is not yet decided
	 * SearchQ: { type, diff, keys } 
	 *    type: Always SearchQ for searching questions, used by server
	 *    diff: An array of booleans specifying which difficulty questions to return
	 *    keys: An array of keywords that should match the returned questions*/
	function sendRequest(reqType) {
		var xhttp   = new XMLHttpRequest();
		var jsonObj = {
			"Type"  : reqType,
		}
		// Fill in reqType-specific object fields
		if(reqType === "AddQ"){
			jsonObj["Desc"]  = addDesc.value;
			jsonObj["Topic"] = addTopic.value;
			jsonObj["Diff"]  = getCheckedValue("addDiff");
			jsonObj["Tests"] = getNonEmptyInputs("addTests");
		} else if(reqType === "SearchQ") {
			jsonObj["Diffs"] = getCheckedValues("searchDiff");
			jsonObj["Topic"] = searchTopic.value;
			jsonObj["Keys"]  = getNonEmptyInputs("searchKeys");
		} else {
			console.log("Invalid reqType passed to sendRequest()");
		}

		var jsonStr = JSON.stringify(jsonObj);
		console.log("Sent: " + jsonStr);
		xhttp.onreadystatechange = function() {
			if (xhttp.readyState == 4 && xhttp.status == 200) {
				//console.log("Rcvd: " + xhttp.responseText);
				var replyObj = JSON.parse(xhttp.responseText);
				
				if( replyObj["Error"] != 0 ){
					console.log("Error: " + replyObj["Error"]);
				} else {
					if(replyObj["Type"] === "AddQ"){
						//localQ.push(replyObj["Question"]);
						localQ.push(replyObj);
						console.log(localQ);
					} else if(replyObj["Type"] === "SearchQ") {
						// Loop through DB Q's, adding each to local Q's
						var DBQ = replyObj["Questions"];
						for(var i=0; i<DBQ.length; i++){
							if(uniqQuestion(DBQ[i])){
								localQ.push(DBQ[i]);
							}
						}
						console.log(localQ);
					}
				}
			}
		};
		xhttp.open("POST", "https://web.njit.edu/~djo23/CS490/curlObj.php", true);
		xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhttp.send(jsonStr);
	}
	</script>
</body>

</html>

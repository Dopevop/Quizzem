<!DOCTYPE html>
<html>
<head>
	<title>Quizzum</title>
	<meta name="description" content="Instructor's page for creating questions and building exams.">
	<meta name="keywords"    content="Computer Science, Exam, Questions, Instructor, NJIT, Python">
	<meta name="author"      content="Devon J O'Connor">
	<meta name="viewport"    content="width=device-width, initial-scale=1.0">
</head>
<body>
	<form id="addForm">
		<fieldset>
			<legend>Create Question:</legend>
			Description </br>
			<input id="addDesc"   type="text"> </br>

			<div id="addDiff">
				Difficulty </br>
				<label><input type="radio" name="diff" value="1">Very Easy</label></br>
				<label><input type="radio" name="diff" value="2">Easy</label></br>
				<label><input type="radio" name="diff" value="3">Medium</label></br>
				<label><input type="radio" name="diff" value="4">Hard</label></br>
				<label><input type="radio" name="diff" value="5">Very Hard</label></br>
			</div>

			<div   id="addKeys"   class="modular keys"></div>
			<div   id="addTests"  class="modular tests"></div>
			</br>
			<button id="addSub"   type="button">Submit</button> 
			<button id="addClear" type="reset">Clear</button> 
		</fieldset>
	</form>	
	<form id="searchForm">
		<fieldset>
			<legend>Search for Questions</legend>
			Difficulty </br>
			<input id ="searchEasy" type ="checkbox" name="diff" value="easy">
			<label for="searchEasy">Easy</label> </br>
			<input id ="searchMed"  type ="checkbox" name="diff" value="medium">
			<label for="searchMed">Medium</label> </br>
			<input id ="searchHard" type ="checkbox" name="diff" value="hard">
			<label for="searchHard">Hard</label> </br>
			<div id   ="searchKeys" class="modular keys"></div>
			</br>
			<button id="searchSub" type="button">Submit</button> 
			<button id="searchClear"  type="reset">Clear</button> 
		</fieldset>
	</form>
	<script>
	/* Adding event listeners to submit and clear buttons 
	 * Uses the id short hand rather than document.getElementById(id) */
	addSub.addEventListener("click"     , function(){sendForm("AddQ")});
	searchSub.addEventListener("click"  , function(){sendForm("SearchQ")});
	addClear.addEventListener("click"   , function(){clearForm("addForm")});
	searchClear.addEventListener("click", function(){clearForm("searchForm")});

	/* Initializes the modular elements */
	resetInput("Test Cases", "addTests"  , 'addInput("addTests")');
	resetInput("Keywords"  , "addKeys"   , 'addInput("addKeys")');
	resetInput("Keywords"  , "searchKeys", 'addInput("searchKeys")');

	/* Add another input text box to the top of the specified element.
	 * Works for elements that contain a label, a button, and then a list of inputs 
	 * elemId: The id of the element you want to add the input box to */
	function addInput(elemId) {
		var elem      = document.getElementById(elemId);
		var textInput = document.createElement("INPUT");
		var breakElem = document.createElement("BR");
		elem.insertBefore(textInput, elem.childNodes[4]);
		elem.insertBefore(breakElem, elem.childNodes[4]);
	}

	/* Resets an input div to contain a label, a button for adding more inputs,
	 * and a single text input.
	 * label: The label of the input fields (e.g. Keywords, or Test Cases)
	 * elemId: The id of the button that will be added to this  */
	function resetInput(label, elemId, func) {
		var htmlStr = "" + label + '<button id="' + elemId + '" type="button" ' +
			'onclick=' + func + '>+</button></br><input type="text">';
		document.getElementById(elemId).innerHTML = htmlStr;
	}

	/* Resets all of the modular elements inside of the specified element.
	 * Modular elems are those such as keywords where more can be added
	 * The given id should contain modular elements, most likely a form */
	function clearForm(formId) {
		var elems = document.getElementById(formId).getElementsByClassName("modular");
		for(var i=0; i<elems.length; i++) {
			var classes = elems[i].classList;
			if(classes.contains("modular")) {
				if(classes.contains("tests")) {
					resetInput("Test Cases", elems[i].id, 'addInput("'+elems[i].id+'")');
				} else {
					resetInput("Keywords"  , elems[i].id, 'addInput("'+elems[i].id+'")');
				}
			}
		}
	}

	/* Returns the value of the first checked input element contained by the given element 
	 * This assumes radio input types inside a div of their own */
	function getCheckedValue(divId) {
		var elems = document.getElementById(divId).getElementsByTagName("INPUT");
		for(var i=0; i<elems.length; i++){
			if(elems[i].checked){
				return elems[i].value;
			}
		}
	}

	/* Posts the new question to be added to the database
	 * Sends the Type, Description, an array of Keywords, and an array of Tests
	 * The JSON sent and the response received are both made into alerts 
	 * The response should be in JSON format or will result in an error */
	function sendForm(type) {
		var xhttp  = new XMLHttpRequest();
		// Create new object with type and description initialized; Keywords and Tests declared.
		var jsonObj = {
			"Type"  : type,
			"Desc"  : addDesc.value,
			"Diff"  : getCheckedValue("addDiff"),
			"Keys"  : [],
			"Tests" : []
		}
		// Loop through all keywords given add to KeyWs array
		var keywordFields = document.getElementById("addKeys").children;
		for(var i = 0; i < keywordFields.length; i++) {
			if(keywordFields[i].tagName == "INPUT")
				jsonObj["Keys"].push(keywordFields[i].value);
		}
		// Loop through all test cases given and add to Tests array
		var testFields = document.getElementById("addTests").children;
		for(var i = 0; i < testFields.length; i++) {
			if(testFields[i].tagName == "INPUT")
				jsonObj["Tests"].push(testFields[i].value);
		}
		var jsonStr = JSON.stringify(jsonObj);
		console.log("Sending: " + jsonStr);					// <--- JUST FOR TESTING, REMOVE LATER
		xhttp.onreadystatechange = function() {
			if (xhttp.readyState == 4 && xhttp.status == 200) {
				console.log(xhttp.responseText);
			}
		};
		xhttp.open("POST", "https://web.njit.edu/~djo23/CS490/curlObj.php", true);
		xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhttp.send(jsonStr);
	}
	</script>
</body>

</html>
